function Chat(t,e){this.msgbox=0,this.room=t,this.messages=[],this.myMessages=[],this.typing=null,this.editMode=-1,this.$messages=$("#messages"),this.$message=$("#message"),this.$content=$("#content"),this.$chat=$("#chat"),this.init(e)}function Dice2D(t,e,s,i){this.id=t,this.type=e,this.value=parseInt(this.type.replace("d","").split(" ")[0]),this.box=i,this.radius=.25*this.box.scale,this.color=s,this.transform,this.position={x:0,y:0,z:0},this.rotation=0,this.time=0,this.createMesh()}function Dices2D(t,e,s){this.room=t,this.w=e,this.h=s,this.cw,this.ch,this.scale,this.scene,this.dices={},this.init()}Chat.prototype.getMessageIndexById=function(t){for(var e=this.messages.length-1;0<=e;e--)if(this.messages[e].id==t)return e;return-1},Chat.prototype.addMessage=function(t,e){t.user.name==this.room.user.name&&e&&this.myMessages.push(t),this.messages.push(t)},Chat.prototype.getClass=function(t){var e="";return t.user.name==this.room.user.name&&(e+=" me"),t.user.admin&&(e+=" admin"),t.prive&&(e+=" prive"),e},Chat.prototype.isNewBox=function(t){return!(0<this.messages.length&&this.messages[this.messages.length-1].user.name==t.user.name&&!this.messages[this.messages.length-1].command&&!this.messages[this.messages.length-1].image&&this.messages[this.messages.length-1].prive==t.prive)},Chat.prototype.showCommand=function(t){return"/roll"===t.command&&(this.$messages.append($('<li id="msgbox-'+ ++this.msgbox+'" class="diceroll mui-panel'+this.getClass(t)+'">').html('<span class="user">'+(t.prive?t.user.name+" to "+t.prive:t.user.name)+":</span> "+t.message)),this.addMessage(t,!1),this.room.users.showLastDice(t.user,t.message),t.user.name==this.room.user.name&&this.room.dices.roll(t.dice)),this.$content.scrollTop(this.$content[0].scrollHeight),!0},Chat.prototype.showError=function(t){t.user.name="error",this.$messages.append($('<li id="msgbox-'+ ++this.msgbox+'" class="message '+t.error+' me">').html(t.message)),this.addMessage(t,!1),this.$content.scrollTop(this.$content[0].scrollHeight)},Chat.prototype.showImage=function(t){var e='<div id="image-'+t.image+'"><a href="#" data-image="'+t.image+'">Download image '+t.name+"</a></div>";this.isNewBox(t)?this.$messages.append('<li id="msgbox-'+ ++this.msgbox+'" class="message mui-panel'+this.getClass(t)+'"><div class="user">'+(t.prive?t.user.name+" to "+t.prive:t.user.name)+':</div> <div class="text">'+e+"</div></li>"):$("#msgbox-"+this.msgbox).find(".text").append(e),this.addMessage(t,!1),this.$content.scrollTop(this.$content[0].scrollHeight)},Chat.prototype.message=function(t){t.error?this.showError(t):t.command?this.showCommand(t):void 0===t.image?(this.isNewBox(t)?this.$messages.append('<li id="msgbox-'+ ++this.msgbox+'" class="message mui-panel'+this.getClass(t)+'"><div class="user">'+(t.prive?t.user.name+" to "+t.prive:t.user.name)+':</div> <div class="text"><div id="msg-'+t.id+'">'+t.message+"</div></div></li>"):$("#msgbox-"+this.msgbox).find(".text").append('<div id="msg-'+t.id+'">'+t.message+"</div>"),this.addMessage(t,!0),this.$content.scrollTop(this.$content[0].scrollHeight)):this.showImage(t)},Chat.prototype.editMessage=function(t){var e,s;t.error||t.command||t.image||0<=(e=this.getMessageIndexById(t.id))&&(0<=(s=this.myMessages.indexOf(this.messages[e]))&&(this.myMessages[s]=t),this.messages[e]=t,$("#msg-"+t.id).html(t.message))},Chat.prototype.typingStart=function(){var t=this;this.typing?clearTimeout(this.typing):this.room.socket.emit("typing start"),this.typing=setTimeout(function(){t.typingStop()},2500)},Chat.prototype.typingStop=function(){clearTimeout(this.typing),this.typing=null,this.room.socket.emit("typing stop")},Chat.prototype.startEdit=function(){var t;0<=this.editMode&&((t=this).$message.focus(),this.$message.val(this.myMessages[this.editMode].message),setTimeout(function(){t.$message.putCursorAtEnd()},0))},Chat.prototype.stopEdit=function(){0<=this.editMode&&(this.$message.val(""),this.editMode=-1)},Chat.prototype.editPrev=function(){this.editMode<=0&&(this.editMode=this.myMessages.length),--this.editMode,this.startEdit()},Chat.prototype.editNext=function(){++this.editMode,this.editMode>=this.myMessages.length?this.stopEdit():this.startEdit()},Chat.prototype.checkEndEdit=function(){""==this.$message.val()&&(this.editMode=-1)},Chat.prototype.init=function(t){var s=this;for(i=0,length=t.length;i<length;i++)this.message(t[i]);this.$chat.on("submit.chat",function(t){t.preventDefault();var e=s.$message.val();return""!=e&&(0<=s.editMode?((t=s.myMessages[s.editMode]).prive&&(e="@"+t.prive+" "+e),s.room.socket.emit("chat edit",t.id,e),s.stopEdit()):s.room.socket.emit("chat",e),s.$message.val(""),s.checkEndEdit(),s.typingStop()),!1}),this.room.socket.on("chat",function(t){s.message(t)}),this.$message.on("keypress.chat",function(t){8!=t.keyCode&&13!=t.keyCode&&s.typingStart()}),this.room.socket.on("chat edit",function(t){s.editMessage(t)}),this.$message.on("keydown.chat",function(t){38==t.keyCode?s.editPrev():40==t.keyCode?s.editNext():8!=t.keyCode&&46!=t.keyCode||s.checkEndEdit()})},Chat.prototype.destroy=function(){this.$chat.off(".chat"),this.$message.off(".chat"),this.room.socket.removeAllListeners("chat"),this.room.socket.removeAllListeners("chat edit")},Dice2D.prototype.createMesh=function(){this.transform=$('<div class="dice '+this.type+'"></div>').css({position:"absolute",top:-this.radius,left:-this.radius,width:2*this.radius,height:2*this.radius,lineHeight:2*this.radius+"px",fontSize:.75*this.radius+"px",fontWeight:"bold",textShadow:"2px 2px 0px #000000, 2px -2px 0px #000000, -2px -2px 0px #000000, -2px 2px 0px #000000"}),this.box.scene.append(this.transform)},Dice2D.prototype.update=function(t){this.position.x=t[0]*this.box.w/1e3/2+this.box.cw,this.position.y=this.box.ch-t[1]*this.box.h/1e3/2,this.position.z=t[2],this.rotation=(2*Math.acos(t[3])*180/Math.PI+180)%360,this.transform.css("transform","translate3d("+this.position.x+"px, "+this.position.y+"px, "+this.position.z+"px) rotate("+this.rotation+"deg)"),166<Date.now()-this.time&&(this.transform.html(Math.ceil(Math.random()*this.value)),this.time=Date.now())},Dice2D.prototype.result=function(t){this.transform.html(t)},Dice2D.prototype.remove=function(){this.transform.remove(),delete this.box.dices[this.id]},Dices2D.prototype.init=function(){var s=this;this.cw=this.w/2,this.ch=this.h/2,this.scale=Math.sqrt(this.w*this.w+this.h*this.h)/13,this.dices={},this.scene=$("#dice-box"),this.room.socket.on("dice start",function(t){for(var e=0;e<t.length;e++)s.dices[t[e].id]=new Dice2D(t[e].id,t[e].type,t[e].color,s)}),this.room.socket.on("dice update",function(t){for(var e in t)s.dices[e]&&s.dices[e].update(t[e])}),this.room.socket.on("dice result",function(t){for(var e in t)s.dices[e]&&s.dices[e].result(t[e])}),this.room.socket.on("dice end",function(t){for(var e=0;e<t.length;e++)s.dices[t[e]]&&s.dices[t[e]].remove()})},Dices2D.prototype.remove=function(){this.room.socket.removeAllListeners("dice start"),this.room.socket.removeAllListeners("dice update"),this.room.socket.removeAllListeners("dice result"),this.room.socket.removeAllListeners("dice end")};var DicesModels3D={};function copyto(t,e){if(null==t||"object"!=typeof t)return t;if(t instanceof Array)for(var s=t.length-1;0<=s;--s)e[s]=copy(t[s]);else for(var s in t)t.hasOwnProperty(s)&&(e[s]=copy(t[s]));return e}function copy(t){return t&&copyto(t,new t.constructor)}function makeGeometry(t,e,s,i,o){for(var n=new THREE.Geometry,a=0;a<t.length;++a){var r=(new THREE.Vector3).fromArray(t[a]).normalize().multiplyScalar(s);r.index=n.vertices.push(r)-1}for(a=0;a<e.length;++a)for(var h=e[a],c=h.length-1,l=2*Math.PI/c,u=0;u<c-2;++u)n.faces.push(new THREE.Face3(h[0],h[u+1],h[u+2],[n.vertices[h[0]],n.vertices[h[u+1]],n.vertices[h[u+2]]],0,h[c]+1)),n.faceVertexUvs[0].push([new THREE.Vector2((Math.cos(o)+1+i)/2/(1+i),(Math.sin(o)+1+i)/2/(1+i)),new THREE.Vector2((Math.cos(l*(u+1)+o)+1+i)/2/(1+i),(Math.sin(l*(u+1)+o)+1+i)/2/(1+i)),new THREE.Vector2((Math.cos(l*(u+2)+o)+1+i)/2/(1+i),(Math.sin(l*(u+2)+o)+1+i)/2/(1+i))]);return n.computeFaceNormals(),n.computeVertexNormals(),n.boundingSphere=new THREE.Sphere(new THREE.Vector3,s),n}DicesModels3D.d4={geometry:{vertices:[[1,1,1],[-1,-1,1],[-1,1,-1],[1,-1,-1]],faces:[[1,0,2,1],[0,1,3,2],[0,3,2,3],[1,2,3,4]],tab:-.1,af:7*Math.PI/6},mass:300,inertia:5,scale:1},DicesModels3D.d6={geometry:{vertices:[[-1,-1,-1],[1,-1,-1],[1,1,-1],[-1,1,-1],[-1,-1,1],[1,-1,1],[1,1,1],[-1,1,1]],faces:[[0,3,2,1,1],[1,2,6,5,2],[0,1,5,4,3],[3,7,6,2,4],[0,4,7,3,5],[4,5,6,7,6]],tab:.1,af:Math.PI/4},mass:300,inertia:13,scale:1.1},DicesModels3D.d8={geometry:{vertices:[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1]],faces:[[0,2,4,1],[0,4,3,2],[0,3,5,3],[0,5,2,4],[1,3,4,5],[1,4,2,6],[1,2,5,7],[1,5,3,8]],tab:0,af:-Math.PI/4/2},mass:340,inertia:10,scale:1.1},DicesModels3D.d10={geometry:{vertices:function(){for(var t=2*Math.PI/10,e=(Math.cos(t),[]),s=0,i=0;s<10;++s,i+=t)e.push([Math.cos(i),Math.sin(i),.105*(s%2?1:-1)]);return e.push([0,0,-1]),e.push([0,0,1]),e}(),faces:[[5,7,11,0],[4,2,10,1],[1,3,11,2],[0,8,10,3],[7,9,11,4],[8,6,10,5],[9,1,11,6],[2,0,10,7],[3,5,11,8],[6,4,10,9],[5,6,7,-1],[3,2,4,-1],[1,2,3,-1],[9,8,0,-1],[7,8,9,-1],[7,6,8,-1],[9,0,1,-1],[1,0,2,-1],[3,4,5,-1],[5,4,6,-1]],tab:0,af:6*Math.PI/5},mass:350,inertia:9,scale:1},DicesModels3D.d12={geometry:{vertices:function(){var t=(1+Math.sqrt(5))/2,e=1/t;return[[0,e,t],[0,e,-t],[0,-e,t],[0,-e,-t],[t,0,e],[t,0,-e],[-t,0,e],[-t,0,-e],[e,t,0],[e,-t,0],[-e,t,0],[-e,-t,0],[1,1,1],[1,1,-1],[1,-1,1],[1,-1,-1],[-1,1,1],[-1,1,-1],[-1,-1,1],[-1,-1,-1]]}(),faces:[[2,14,4,12,0,1],[15,9,11,19,3,2],[16,10,17,7,6,3],[6,7,19,11,18,4],[6,18,2,0,16,5],[18,11,9,14,2,6],[1,17,10,8,13,7],[1,13,5,15,3,8],[13,8,12,4,5,9],[5,4,14,9,15,10],[0,12,8,10,16,11],[3,19,7,17,1,12]],tab:.2,af:-Math.PI/4/2},mass:380,inertia:8,scale:1},DicesModels3D.d20={geometry:{vertices:function(){var t=(1+Math.sqrt(5))/2;return[[-1,t,0],[1,t,0],[-1,-t,0],[1,-t,0],[0,-1,t],[0,1,t],[0,-1,-t],[0,1,-t],[t,0,-1],[t,0,1],[-t,0,-1],[-t,0,1]]}(),faces:[[0,11,5,1],[0,5,1,2],[0,1,7,3],[0,7,10,4],[0,10,11,5],[1,5,9,6],[5,11,4,7],[11,10,2,8],[10,7,6,9],[7,1,8,10],[3,9,4,11],[3,4,2,12],[3,2,6,13],[3,6,8,14],[3,8,9,15],[4,9,5,16],[2,4,11,17],[6,2,10,18],[8,6,7,19],[9,8,1,20]],tab:-.2,af:-Math.PI/4/2},mass:400,inertia:6,scale:1},DicesModels3D.d100={geometry:DicesModels3D.d10.geometry,mass:350,inertia:9,scale:1};var materialOptions={specular:"#171d1f",color:"#ffffff",emissive:"#000000",shininess:7,shading:THREE.FlatShading},diceLabels=[" ","0","1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20"],d10Labels=[" ","1","2","3","4","5","6","7","8","9","0"],d100Labels=[" ","10","20","30","40","50","60","70","80","90","00"];function idealTextColor(t){t=getRGBComponents(t);return 255-(.299*t.R+.587*t.G+.114*t.B)<105?"#000000":"#ffffff"}function getRGBComponents(t){var e=t.substring(1,3),s=t.substring(3,5),t=t.substring(5,7);return{R:parseInt(e,16),G:parseInt(s,16),B:parseInt(t,16)}}function makeDiceMaterials(t,e,n,a){for(var s=[],i=0;i<e.length;++i)s.push(new THREE.MeshPhongMaterial(copyto(materialOptions,{map:function(t,e,s){if(null==t)return null;var i=document.createElement("canvas"),o=i.getContext("2d");return i.width=n+a,i.height=n+a,o.font=n+"pt Arial",o.fillStyle=s,o.fillRect(0,0,i.width,i.height),o.textAlign="center",o.textBaseline="middle",o.fillStyle=e,o.fillText(t,i.width/2,i.height/2),"6"!=t&&"9"!=t||o.fillText("  .",i.width/2,i.height/2),(i=new THREE.Texture(i)).needsUpdate=!0,i}(e[i],idealTextColor(t),t)})));return s}function makeD4Materials(t,a,r){for(var e=[],s=[[],[0,0,0],[2,4,3],[1,3,4],[2,1,4],[1,2,3]],i=0;i<s.length;++i)e.push(new THREE.MeshPhongMaterial(copyto(materialOptions,{map:function(t,e,s){var i,o=document.createElement("canvas"),n=o.getContext("2d");for(i in o.width=a+r,o.height=a+r,n.font=a+"pt Arial",n.fillStyle=s,n.fillRect(0,0,o.width,o.height),n.textAlign="center",n.textBaseline="middle",n.fillStyle=e,n.translate(0,a/10),t)n.fillText(t[i],o.width/2,o.height/2-a-r/10),n.translate(o.width/2,o.height/2),n.rotate(2*Math.PI/3),n.translate(-o.width/2,-o.height/2);return(e=new THREE.Texture(o)).needsUpdate=!0,e}(s[i],idealTextColor(t),t)})));return e}function Dice3D(t,e,s,i){this.id=t,this.type=e,this.box=i,this.radius=.6*DicesModels3D[this.type].scale*i.scale,this.color=s,this.transform,this.createMesh(),this.box.renderer.render(this.box.scene,this.box.camera)}function Dices3D(t,e,s){this.room=t,this.w=e,this.h=s,this.cw,this.ch,this.scene,this.camera,this.renderer,this.aspect,this.scale,this.desk,this.light,this.dices={},this.init()}function Dice(t){this.type=t,this.rolls=0,this.cooldown=null,this.$item=$('<div class="dice d'+t.split("d").pop()+' noselect">'+t+"</div>")}function Dices(t,e){this.room=t,this.defaultDices=e||[],this.dices=[],this.$dices=$("#dices"),this.reset(),this.init()}function Images(t){this.room=t,this.image="",this.$zoom=null,this.init()}function LocalPlayer(t){this.music=t,this.audio=new Audio,this.volet=0,this.init()}function YoutubePlayer(t){this.music=t,this.index=0,this.youtube,this.$musicUrl,this.$playLater,this.$playNow,this.init()}function Music(t){this.room=t,this.playlist=[],this.current=0,this.savedVolume=0,this.currentVolume=0,this.localPlayer,this.youtubePlayer,this.player,this.$play=$("#play"),this.$mute=$("#mute"),this.$volume=$("#volume"),this.$bar=this.$volume.find(".audio-volume-bar"),this.$musicPlayer=$("#music-player"),this.$musicPopin,this.init()}Dice3D.prototype.createMesh=function(){var t=DicesModels3D[this.type],e=makeGeometry(t.geometry.vertices,t.geometry.faces,this.radius,t.geometry.tab,t.geometry.af),t="d4"==this.type?makeD4Materials(this.color,this.box.scale/3,this.box.scale):"d100"==this.type?makeDiceMaterials(this.color,d100Labels,this.box.scale/3,this.box.scale):"d10"==this.type?makeDiceMaterials(this.color,d10Labels,this.box.scale/3,this.box.scale):makeDiceMaterials(this.color,diceLabels,this.box.scale/3,this.box.scale),t=new THREE.Mesh(e,new THREE.MeshFaceMaterial(t));t.castShadow=!0,t.receiveShadow=!1,t.position.x=2*-this.box.w,t.position.y=2*-this.box.h,t.position.z=0,t.quaternion.x=0,t.quaternion.y=0,t.quaternion.z=0,t.quaternion.w=0,this.transform=t,this.box.scene.add(t)},Dice3D.prototype.update=function(t){this.transform.position.x=t[0]*this.box.w/1e3,this.transform.position.y=t[1]*this.box.h/1e3,this.transform.position.z=t[2],this.transform.quaternion.x=t[3],this.transform.quaternion.y=t[4],this.transform.quaternion.z=t[5],this.transform.quaternion.w=t[6]},Dice3D.prototype.remove=function(){this.box.scene.remove(this.transform),delete this.box.dices[this.id]},Dices3D.prototype.resize=function(){this.w=window.innerWidth,this.h=window.innerHeight,this.cw=this.w/2,this.ch=this.h/2,this.aspect=Math.min(this.cw/this.w,this.ch/this.h),this.scale=Math.sqrt(this.w*this.w+this.h*this.h)/13;var t=Math.min(this.cw,this.ch)/this.aspect/Math.tan(10*Math.PI/180);this.camera.aspect=this.cw/this.ch,this.camera.far=1.3*t,this.camera.position.z=t,this.camera.updateProjectionMatrix();t=Math.max(this.w,this.h);this.light.position.set(-t/2,t/2,2*t),this.light.target.position.set(0,0,0),this.renderer.setSize(this.w,this.h)},Dices3D.prototype.init=function(){var s=this;this.cw=this.w/2,this.ch=this.h/2,this.aspect=Math.min(this.cw/this.w,this.ch/this.h),this.scale=Math.sqrt(this.w*this.w+this.h*this.h)/13,this.renderer=new(window.WebGLRenderingContext?THREE.WebGLRenderer:THREE.CanvasRenderer)({antialias:!0,alpha:!0}),this.renderer.setSize(2*this.cw,2*this.ch),this.renderer.shadowMapEnabled=!0,this.renderer.shadowMapSoft=!0,this.renderer.setClearColor(0,0),this.dices={},this.scene=new THREE.Scene,this.scene.fog=null,$("#dice-box").append(this.renderer.domElement);var t=Math.min(this.cw,this.ch)/this.aspect/Math.tan(10*Math.PI/180);this.camera=new THREE.PerspectiveCamera(20,this.cw/this.ch,1,1.3*t),this.camera.position.z=t;t=new THREE.AmbientLight(6710886);this.scene.add(t);t=Math.max(this.w,this.h);this.light=new THREE.SpotLight(16777215),this.light.position.set(-t/2,t/2,2*t),this.light.target.position.set(0,0,0),this.light.castShadow=!0,this.light.shadowCameraNear=t/10,this.light.shadowCameraFar=3*t,this.light.shadowCameraFov=50,this.light.shadowBias=.001,this.light.shadowDarkness=.3,this.light.shadowMapWidth=1024,this.light.shadowMapHeight=1024,this.scene.add(this.light);t=["uniform vec3 diffuse;","uniform float opacity;",THREE.ShaderChunk.color_pars_fragment,THREE.ShaderChunk.map_pars_fragment,THREE.ShaderChunk.lightmap_pars_fragment,THREE.ShaderChunk.envmap_pars_fragment,THREE.ShaderChunk.fog_pars_fragment,THREE.ShaderChunk.shadowmap_pars_fragment,THREE.ShaderChunk.specularmap_pars_fragment,"void main() {","gl_FragColor = vec4( 1.0, 1.0, 1.0, 1.0 );",THREE.ShaderChunk.map_fragment,THREE.ShaderChunk.alphatest_fragment,THREE.ShaderChunk.specularmap_fragment,THREE.ShaderChunk.lightmap_fragment,THREE.ShaderChunk.color_fragment,THREE.ShaderChunk.envmap_fragment,THREE.ShaderChunk.shadowmap_fragment,THREE.ShaderChunk.linear_to_gamma_fragment,THREE.ShaderChunk.fog_fragment,"gl_FragColor = vec4( 0.0, 0.0, 0.0, 1.0 - shadowColor.x );","}"].join("\n"),t=new THREE.ShaderMaterial({uniforms:THREE.ShaderLib.basic.uniforms,vertexShader:THREE.ShaderLib.basic.vertexShader,fragmentShader:t,color:255});this.desk=new THREE.Mesh(new THREE.PlaneGeometry(2*this.w,2*this.h,1,1),t),this.desk.receiveShadow=!0,this.scene.add(this.desk),window.addEventListener("click",this.resize.bind(this)),this.room.socket.on("dice start",function(t){for(var e=0;e<t.length;e++)s.dices[t[e].id]=new Dice3D(t[e].id,t[e].type,t[e].color,s)}),this.room.socket.on("dice update",function(t){for(var e in t)s.dices[e]&&s.dices[e].update(t[e]);s.renderer.render(s.scene,s.camera)}),this.room.socket.on("dice end",function(t){for(var e=0;e<t.length;e++)s.dices[t[e]]&&s.dices[t[e]].remove();s.renderer.render(s.scene,s.camera)})},Dices3D.prototype.remove=function(){this.room.socket.removeAllListeners("dice start"),this.room.socket.removeAllListeners("dice update"),this.room.socket.removeAllListeners("dice end")},Dice.prototype.roll=function(){var t=this;++this.rolls,this.$item.addClass("cooldown"),clearTimeout(this.cooldown),this.cooldown=setTimeout(function(){t.$item.removeClass("cooldown")},2e3)},Dices.prototype.reset=function(){var s=this;this.dices=[],$.each(this.defaultDices,function(t,e){s.roll(e)})},Dices.prototype.show=function(){this.sort();var t=this.dices.length;this.$dices.children(".dice").detach(),this.$dices.css({width:45*t,height:45*t});for(var e=0;e<t;e++)this.$dices.append(this.dices[e].$item)},Dices.prototype.sort=function(){this.dices.sort(function(t,e){return e.rolls-t.rolls})},Dices.prototype.roll=function(t){"1"==(t=t.split("d"))[0]&&(t[0]=""),t=t.join("d");for(var e=!1,s=this.dices.length-1;0<=s;s--)if(this.dices[s].type==t){e=!0,this.dices[s].roll();break}e||this.dices.push(new Dice(t)),this.show()},Dices.prototype.init=function(){var e=this;$(window).on("resize.dices",function(){e.show()}),$(document).on("click.dices",".dice",function(t){t.preventDefault();t=$(this);t.hasClass("cooldown")||(t.addClass("cooldown"),t=t.html(),e.room.socket.emit("chat","/roll "+t))})},Dices.prototype.destroy=function(){$(window).off(".dices"),$(document).off(".dices")},Images.prototype.show=function(t){$("#image-"+t.id).html('<img class="zoomable link" src="'+t.url+'" alt="'+t.name+'" title="'+t.name+'">')},Images.prototype.close=function(){this.$zoom&&(this.$zoom.off(".images"),this.$zoom.remove(),this.$zoom=null)},Images.prototype.zoom=function(t){var e;this.$zoom||((e=this).$zoom=$('<div class="overlay centerer closable"><div class="image centered"><img class="zoomed" src="'+t+'" alt=""></div></div>'),$("body").append(this.$zoom),this.$zoom.on("click.images",function(){e.close()}))},Images.prototype.upload=function(e){var s;"image"==e.type.split("/").shift()&&(s=this,reader=new FileReader,reader.onload=function(t){s.room.socket.emit("image upload",e.name,t.target.result)},reader.readAsDataURL(e))},Images.prototype.download=function(t){this.room.socket.emit("image download",t)},Images.prototype.init=function(){var e=this;$("body").on("dragover.images",function(t){t.preventDefault()}).on("drop.images",function(t){t.preventDefault(),e.upload(t.originalEvent.dataTransfer.files[0])}).on("click.images",".zoomable",function(t){t.preventDefault(),e.zoom($(this).attr("src"))}).on("click.images","[data-image]",function(t){t.preventDefault(),$(this).append(' <i class="fa fa-spin fa-refresh"></i>'),e.download($(this).attr("data-image"))}),this.room.socket.on("image",function(t){e.show(t)})},Images.prototype.destroy=function(){this.close(),$("body").off(".images")},function(){var t=(Config||{}).url||"http://localhost:3030",o=io(t),n=!1;function e(t,e,s,i){""==e||""==s||n||(n=!0,t.append('<span id="loading">&nbsp;&nbsp;<i class="fa fa-spin fa-refresh"></i></span>'),o.emit(i,{room:e,user:s}))}function s(){return e($("#join"),$("#room").val(),$("#user").val(),"room join"),!1}function i(){return e($("#create"),$("#room").val(),$("#user").val(),"room create"),!1}window.addEventListener("DOMContentLoaded",function(){o.on("login",function(t){n=!1,$("#loading").remove(),t.succes?(new Room(o,t.room.name,t.user,t.room.users,t.room.messages,t.room.settings),Cookies.set("login",t.room.name+"|"+t.user.name,{expires:356}),$(".login-wrapper").fadeOut(300)):$("#login-msg").html(t.error).addClass("error")}),$("#login").submit(s),$("#join").click(s),$("#create").click(i);var t=Cookies.get("login");t&&(t=t.split("|"),e($("#join"),t[0],t[1],"room join"))})}(),LocalPlayer.prototype.init=function(){var e=this;document.body.appendChild(this.audio),this.audio.autoplay=!0,this.audio.loop=!0,e.music.room.user.admin&&$.post("music/list.php",function(t){e.music.$musicPopin.find(".local-contener").append(e.crawlSongs(t)),$("body").on("click.music",".song .fa-play",function(t){t.preventDefault(),e.song($(this).parent().parent(),!1)}),$("body").on("click.music",".song .fa-plus",function(t){t.preventDefault(),e.song($(this).parent().parent(),!0)}),$("body").on("click.music",".playlist .fa-play",function(t){t.preventDefault(),e.playlist($(this).parent().parent(),!1)}),$("body").on("click.music",".playlist .fa-plus",function(t){t.preventDefault(),e.playlist($(this).parent().parent(),!0)})})},LocalPlayer.prototype.song=function(t,e){this.music.$musicPopin.fadeOut(300);t={type:"local",add:e,url:[t.attr("data-song")]};this.music.room.socket.emit("music",t)},LocalPlayer.prototype.playlist=function(t,e){var s={type:"local",add:e,url:[]};this.music.$musicPopin.fadeOut(300),t.next("input").next("label").next("ul").find(".song").each(function(){s.url.push($(this).attr("data-song"))}),this.music.room.socket.emit("music",s)},LocalPlayer.prototype.crawlSongs=function(t){++this.volet;var e="";e+='<h4 class="playlist list link">'+t.title+'<span class="icon-play"><i class="fa fa-plus"></i><i class="fa fa-play"></i></span></h4>',e+='<input id="volet-'+this.volet+'" type="checkbox" '+(1==this.volet?"checked":"")+' class="volet-checkbox">',e+='<label for="volet-'+this.volet+'" class="volet-btn link fa fa-caret-right"></label>',e+='<ul class="volet-content">';for(var s=0;s<t.songs.length;s++)"playlist"==t.songs[s].type?e+="<li>"+this.crawlSongs(t.songs[s])+"</li>":e+='<li class="song list link" data-song="music/'+t.songs[s].url+'">'+t.songs[s].title+'<span class="icon-play"><i class="fa fa-plus"></i><i class="fa fa-play"></i></span></li>';return e+="</ul>"},LocalPlayer.prototype.start=function(t){this.audio.src=t.url,this.play()},LocalPlayer.prototype.pause=function(){this.audio.pause()},LocalPlayer.prototype.play=function(){this.audio.play()},LocalPlayer.prototype.volume=function(t){this.audio.volume=Math.max(0,Math.min(t,1))},LocalPlayer.prototype.destroy=function(){console.log(this.audio),this.audio.parentNode.removeChild(this.audio)},YoutubePlayer.prototype.init=function(){var e=this,t=document.createElement("script");t.src="https://www.youtube.com/iframe_api";var s=document.getElementsByTagName("script")[0];function i(t){console.log("player ready"),e.music.room.user.admin&&(e.music.$musicPopin.find(".youtube-contener").append('<div class="mui-form-group"><input id="music-url" type="text" class="mui-form-control" placeholder="https://www.youtube.com/watch?v=KqeKikpLQ5o"><label>Youtube url</label></div><button id="play-later" class="mui-btn mui-btn-flat mui-btn-default mui-pull-left">To playlist</button><button id="play-now" class="mui-btn mui-btn-raised mui-btn-primary mui-pull-right">Play now</button>'),e.$musicUrl=$("#music-url"),e.$playLater=$("#play-later"),e.$playNow=$("#play-now"),e.$playNow.on("click.music",function(t){t.preventDefault();t=e.$musicUrl[0].value,t=e.parseURL(t);t.add=!1,e.music.$musicPopin.fadeOut(300),e.music.room.socket.emit("music",t)}),e.$playLater.on("click.music",function(t){t.preventDefault();t=e.$musicUrl[0].value,t=e.parseURL(t);t.add=!0,e.music.$musicPopin.fadeOut(300),e.music.room.socket.emit("music",t)}))}function o(t){t.data==YT.PlayerState.PLAYING&&(e.index=t.target.getPlaylistIndex()),t.data==YT.PlayerState.ENDED&&e.index==t.target.getPlaylist().length-1&&e.music.next()}s.parentNode.insertBefore(t,s),window.onYouTubeIframeAPIReady=function(){e.youtube=new YT.Player("yt-player",{height:"1",width:"1",events:{onReady:i,onStateChange:o}})}},YoutubePlayer.prototype.parseURL=function(t){var e="video";return-1!=t.indexOf("list=")?(t=t.replace(/(>|<)/gi,"").split(/(vi\/|list=|\/v\/|youtu\.be\/|\/embed\/)/),e="playlist"):t=t.replace(/(>|<)/gi,"").split(/(vi\/|v=|\/v\/|youtu\.be\/|\/embed\/)/),{url:(t=void 0!==t[2]?t[2].split(/[^0-9a-z_\-]/i):t)[0],type:e}},YoutubePlayer.prototype.start=function(t){"playlist"==t.type?this.youtube.loadPlaylist({list:t.url}):this.youtube.loadPlaylist(t.url)},YoutubePlayer.prototype.pause=function(){this.youtube.pauseVideo()},YoutubePlayer.prototype.play=function(){this.youtube.playVideo()},YoutubePlayer.prototype.volume=function(t){this.youtube.setVolume(100*Math.max(0,Math.min(t,1)))},YoutubePlayer.prototype.destroy=function(){this.youtube.destroy(),this.music.room.user.admin&&(this.$playNow.off(".music"),this.$playLater.off(".music"))},Music.prototype.load=function(t){if(console.log("data",t),t.add){if("local"==t.type)for(var e=0,s=t.url.length;e<s;e++)this.playlist.push({type:t.type,add:t.add,url:t.url[e]});else this.playlist.push(t);1==this.playlist.length&&(this.current=0,this.start())}else{if(this.playlist=[],"local"==t.type)for(e=0,s=t.url.length;e<s;e++)this.playlist.push({type:t.type,add:t.add,url:t.url[e]});else this.playlist.push(t);this.current=0,this.start()}},Music.prototype.start=function(){console.log(this.playlist),0!==this.playlist.length&&("local"==this.playlist[this.current].type?this.player=this.localPlayer:this.player=this.youtubePlayer,this.player.start(this.playlist[this.current]),this.play())},Music.prototype.next=function(){++this.current>=this.playlist.length&&(this.current=0),this.start()},Music.prototype.play=function(){this.$play.removeClass("fa-play").addClass("fa-pause"),this.player.play(),this.volume(this.currentVolume)},Music.prototype.pause=function(){this.$play.removeClass("fa-pause").addClass("fa-play"),this.player.pause()},Music.prototype.volume=function(t){t=Math.min(Math.max(t,0),1);var e="fa ";this.$mute[0].className=e+=0==t?"fa-volume-off":t<.4?"fa-volume-down":"fa-volume-up",this.$bar.css("width",100*t+"%"),this.player&&this.player.volume(.2*t),this.currentVolume=t},Music.prototype.mute=function(){this.savedVolume=this.currentVolume,this.volume(0)},Music.prototype.unmute=function(){this.volume(this.savedVolume),this.savedVolume=0},Music.prototype.init=function(){var e=this;e.youtubePlayer=new YoutubePlayer(e),e.localPlayer=new LocalPlayer(e),e.volume(.5),e.$volume.on("mousedown.music",function(t){t.preventDefault(),e.volume(Math.round(t.offsetX/$(this).width()*100)/100),$(window).on("mousemove.music",function(t){t=t.clientX-e.$volume.offset().left;e.volume(Math.round(t/e.$volume.width()*100)/100)})}),e.$mute.on("click.music",function(){0==e.savedVolume?e.mute():e.unmute()}),$(window).on("mouseup.music",function(){$(window).off("mousemove.music")}),e.room.socket.on("music",function(t){e.load(t)}),e.room.socket.on("music pause",function(){e.pause()}),e.room.socket.on("music play",function(){e.play()}),e.room.socket.on("music volume",function(t){e.volume(t)}),e.room.user.admin&&($(".room-wrapper").append('<div id="music-player"><div class="music-title">Click to choose song</div></div>'),$(".room-wrapper").append('<div class="music-selector overlay centerer" style="display:none;"><div class="popin mui-panel centered"><i class="music-selector-close popin-close fa fa-times link"></i><div class="youtube-contener"></div><div class="local-contener" style="position:relative;clear:both;"></div></div></div>'),e.$musicPlayer=$("#music-player"),e.$musicPopin=$(".music-selector"),e.$musicPlayer.on("click.music",function(t){t.preventDefault(),e.room.user.admin&&e.$musicPopin.fadeIn(300)}),e.$play.on("click.music",function(t){t.preventDefault(),e.room.user.admin&&($(this).hasClass("fa-play")?e.player?e.room.socket.emit("music play"):e.$musicPopin.fadeIn(300):e.room.socket.emit("music pause"))}),$("body").on("click.music",".music-selector-close",function(){e.$musicPopin.fadeOut(300)}))},Music.prototype.destroy=function(){this.youtubePlayer.destroy(),this.localPlayer.destroy(),this.$volume.off(".music"),this.$mute.off(".music"),this.$play.off(".music"),$("body").off(".music"),$(window).off(".music"),this.room.socket.removeAllListeners("music"),this.room.socket.removeAllListeners("music play"),this.room.socket.removeAllListeners("music pause"),this.room.socket.removeAllListeners("music volume"),this.room.user.admin&&(this.$musicPlayer.remove(),this.$musicPopin.remove())},function(t){var e,s;"function"==typeof define&&define.amd?define(t):"object"==typeof exports?module.exports=t():(e=window.Cookies,(s=window.Cookies=t(window.jQuery)).noConflict=function(){return window.Cookies=e,s})}(function(){function d(){for(var t=0,e={};t<arguments.length;t++){var s,i=arguments[t];for(s in i)e[s]=i[s]}return e}return function t(l){function u(t,e,s){var i,o;if(1<arguments.length){"number"==typeof(s=d({path:"/"},u.defaults,s)).expires&&((o=new Date).setMilliseconds(o.getMilliseconds()+864e5*s.expires),s.expires=o);try{i=JSON.stringify(e),/^[\{\[]/.test(i)&&(e=i)}catch(t){}return e=(e=encodeURIComponent(String(e))).replace(/%(23|24|26|2B|3A|3C|3E|3D|2F|3F|40|5B|5D|5E|60|7B|7D|7C)/g,decodeURIComponent),t=(t=(t=encodeURIComponent(String(t))).replace(/%(23|24|26|2B|5E|60|7C)/g,decodeURIComponent)).replace(/[\(\)]/g,escape),document.cookie=[t,"=",e,s.expires&&"; expires="+s.expires.toUTCString(),s.path&&"; path="+s.path,s.domain&&"; domain="+s.domain,s.secure?"; secure":""].join("")}t||(i={});for(var n=document.cookie?document.cookie.split("; "):[],a=/(%[0-9A-Z]{2})+/g,r=0;r<n.length;r++){var h=n[r].split("="),c=h[0].replace(a,decodeURIComponent);'"'===(h=h.slice(1).join("=")).charAt(0)&&(h=h.slice(1,-1));try{if(h=l&&l(h,c)||h.replace(a,decodeURIComponent),this.json)try{h=JSON.parse(h)}catch(t){}if(t===c){i=h;break}t||(i[c]=h)}catch(t){}}return i}return(u.get=u.set=u).getJSON=function(){return u.apply({json:!0},[].slice.call(arguments))},u.defaults={},u.remove=function(t,e){u(t,"",d(e,{expires:-1}))},u.withConverter=t,u}()}),jQuery.fn.putCursorAtEnd=function(){return this.each(function(){var t;$(this).focus(),this.setSelectionRange?(t=2*$(this).val().length,this.setSelectionRange(t,t)):$(this).val($(this).val()),this.scrollTop=999999})};var hasWebGLSupport=function(){var s=!1,i=!1;return function(){if(!i){var e=null,t=document.createElement("canvas");try{e=t.getContext("webgl")}catch(t){e=null}if(null==e)try{e=t.getContext("experimental-webgl"),experimental=!0}catch(t){e=null}s=!(null==e||!window.WebGLRenderingContext),i=!(t=null)}return s}}();function Room(t,e,s,i,o,n){this.socket=t,this.name=e,this.user=s,this.dices=new Dices(this,n.defaultDices),hasWebGLSupport()?this.dice=new Dices3D(this,window.innerWidth,window.innerHeight):this.dice=new Dices2D(this,window.innerWidth,window.innerHeight),this.users=new Users(this,i),this.images=new Images(this),this.chat=new Chat(this,o),this.music=new Music(this),this.options=n,this.$options=$("#options"),this.$roomName=$("#room-name"),this.$logout=$("#logout"),this.optionsOpened=!1,this.init(i)}function Users(t,e){this.room=t,this.users=[],this.grabbed=null,this.ghost=null,this.$users=$("#users"),this.item,this.init(e)}Room.prototype.init=function(t){var e=this;this.$roomName.text(this.name),this.user.admin&&($("body").addClass("admin-layout").on("click.room",".options-save",$.proxy(e.saveOptions,e)).on("click.room",".options-close",$.proxy(e.closeOptions,e)),this.$options.on("click.room",$.proxy(e.showOptions,e))),this.$logout.on("click.room",function(t){t.preventDefault(),Cookies.remove("login"),e.destroy(),window.location.href=window.location.href}),this.socket.on("change settings",function(t){window.location.href=window.location.href}),this.socket.on("disconnect",function(){e.destroy(),window.location.href=window.location.href})},Room.prototype.showOptions=function(){var t='<div id="options-popin" class="overlay centerer"><div class="popin mui-panel centered"><i class="options-close popin-close fa fa-times link"></i>';t+='<div class="mui-form-group"><label for="options-dices-3d">Use 3D dice</label><input id="options-dices-3d" type="checkbox"'+(this.options.dices3D?" checked":" ")+"></div>",t+='<div class="mui-form-group"><input id="options-default-dices" class="mui-form-control mui-empty mui-dirty" type="text" value="'+this.options.defaultDices.join(",")+'"><label>Default dice (separated by comma)</label></div>',t+='<div class="mui-form-group"><input id="options-custom-roll" class="mui-form-control mui-empty mui-dirty" type="text" value="'+this.options.customRoll+'"><label>/dice command (custom /roll where agument are remplacing $n)</label></div>',t+='<button class="options-close mui-btn mui-btn-flat mui-btn-default mui-pull-left">Cancel</button><button class="options-save mui-btn mui-btn-raised mui-btn-primary mui-pull-right">Save</button>',t+="</div></div>",$("body").append(t),this.optionsOpened=!0},Room.prototype.saveOptions=function(){var t;this.user.admin&&(t={dices3D:$("#options-dices-3d").prop("checked"),defaultDices:$("#options-default-dices").val().split(","),customRoll:$("#options-custom-roll").val()},this.socket.emit("save settings",t),this.closeOptions())},Room.prototype.closeOptions=function(){0!=this.optionsOpened&&($("#options-popin").remove(),this.optionsOpened=!1)},Room.prototype.destroy=function(){$("body").removeClass("admin-layout").off(".room"),this.$roomName.text(""),this.$logout.off(".room"),this.$options.off(".room"),this.dices.destroy(),this.users.destroy(),this.chat.destroy(),this.music.destroy()},Users.prototype.getUserByName=function(t){for(var e=this.users.length-1;0<=e;e--)if(this.users[e].name.toLowerCase()==t.toLowerCase())return this.users[e];return!1},Users.prototype.getUserById=function(t){for(var e=this.users.length-1;0<=e;e--)if(this.users[e].id==t)return this.users[e];return!1},Users.prototype.getIndexById=function(t){for(var e=this.users.length-1;0<=e;e--)if(this.users[e].id==t)return e;return-1},Users.prototype.showUser=function(t){var e="user";t.admin&&(e+=" admin"),t.name==this.room.user.name&&(e+=" me");e='<li data-user="'+t.id+'" data-sort="'+t.order+'" class="user-item '+e+'" id="user-'+t.id+'">'+t.name+'<span class="user-dice"></span><div class="user-details mui-panel">\x3c!--<div class="title"><strong>Characteristics</strong></div><div class="user-health noselect" data-carac="health"><i class="fa fa-heart"></i> <span>8</span></div><div class="user-defense noselect" data-carac="defense"><i class="fa fa-shield"></i> <span>8</span></div>--\x3e<div class="title"><strong>Tokens</strong></div><div class="user-tokens"></div></div></li>';t.admin?this.$users.prepend(e):this.$users.append(e),this.refreshTokens(t)},Users.prototype.addUser=function(t){t.admin?this.users.unshift(t):this.users.push(t),this.showUser(t),this.order()},Users.prototype.removeUser=function(t){var e=this.getIndexById(t.id);0<=e&&this.users.splice(e,1),$("#user-"+t.id).remove(),this.order()},Users.prototype.refreshTokens=function(t){if(u=this.getUserById(t.id),u){u.tokens=t.tokens;var e,s=$("#user-"+t.id+" .user-tokens"),i="";for(e in u.tokens)i+='<div class="token '+e+'" data-user="'+t.id+'" data-token="'+e+'">'+u.tokens[e]+"</div>";""==i?s.html('<div class="notoken">No tokens</div>'):s.html(i)}},Users.prototype.typingStart=function(t){$("#user-"+t.id).addClass("typing")},Users.prototype.typingStop=function(t){$("#user-"+t.id).removeClass("typing")},Users.prototype.showLastDice=function(t,e){$("#user-"+t.id).find(".user-dice").html(e)},Users.prototype.grab=function(t,e){var s;null===this.grabbed&&this.room.user.admin&&!t.hasClass("admin")&&(s=this,$("body").addClass("grabbing"),this.ghost=t.clone().css({position:"absolute",top:"0",left:"0",width:t.outerWidth()+"px",transform:"translate("+e.x+"px, "+e.y+"px)"}).appendTo("body"),this.grabbed=t.addClass("grabbing"),$("body").on("mouseup.sortable",function(t){t.preventDefault(),s.release({x:t.pageX,y:t.pageY})}),$("body").on("mousemove.sortable",function(t){t.preventDefault(),s.grabbing({x:t.pageX,y:t.pageY})}))},Users.prototype.grabbing=function(i){var o;null!==this.grabbed&&((o=this).ghost.css("transform","translate("+i.x+"px, "+i.y+"px)"),this.items.each(function(){var t,e,s=$(this);s.hasClass("grabbing")||s.hasClass("admin")||(t=s.offset().top,e=s.outerHeight(),t<i.y&&i.y<t+e&&(i.y>t+e/2?o.grabbed.after(s):o.grabbed.before(s)))}))},Users.prototype.release=function(){null!==this.grabbed&&($("body").removeClass("grabbing"),this.grabbed.removeClass("grabbing"),this.grabbed=null,this.ghost.remove(),this.ghost=null,$("body").off(".sortable"),this.room.user.admin&&this.ordering())},Users.prototype.order=function(){var e=this;this.items=this.$users.find(".user").sort(function(t,e){return parseInt($(t).data("sort"),10)-parseInt($(e).data("sort"),10)}).each(function(t){$(this).data("sort");e.$users.append($(this))})},Users.prototype.ordering=function(){var s={};this.items=this.$users.find(".user"),this.items.each(function(t){$(this).data("sort",t);var e=$(this).data("user");e&&t&&(s[e]=t)}),this.room.socket.emit("user order",s)},Users.prototype.sort=function(t){for(var e in t){var e=parseInt(e,10),s=this.getUserById(e);s&&(s.order=parseInt(t[e],10),$("#user-"+e).data("sort",t[e]))}this.order()},Users.prototype.init=function(t){for(var s=this,e=0,i=t.length;e<i;e++){var o=t[e];o.connected&&(o.name.toLowerCase()==this.room.user.name.toLowerCase()&&(o=this.room.user),this.addUser(o),this.refreshTokens(o))}this.room.socket.on("user login",function(t){s.addUser(t)}),this.room.socket.on("user logout",function(t){s.removeUser(t)}),this.room.socket.on("typing start",function(t){s.typingStart(t)}),this.room.socket.on("typing stop",function(t){s.typingStop(t)}),this.room.socket.on("token give",function(t){s.refreshTokens(t)}),this.room.socket.on("token use",function(t,e){s.refreshTokens(t);e=$('<div id="token-popin-'+t.id+'" class="before overlay centerer"><div class="popin centered mui-panel text-align-center"><h3>'+t.name+" use "+e+' token</h3><div class="'+e+' token big">&nbsp;</div></div></div>');$("body").append(e),e.delay(2e3).fadeOut(300,function(){$("#token-popin-"+t.id).remove()}),setTimeout(function(){e.removeClass("before")})}),this.room.socket.on("user order",function(t){s.sort(t)}),this.room.user.admin?(this.$users.on("mousedown.sortable",".user-details",function(t){t.preventDefault(),t.stopPropagation()}),this.$users.on("mousedown.sortable",".user",function(t){t.preventDefault(),s.grab($(this),{x:t.pageX,y:t.pageY})}),$("body").on("click.token","#users .user .token",function(){s.room.socket.emit("token use",$(this).data("user"),$(this).data("token"))})):$("body").on("click.token","#user-"+this.room.user.id+" .token",function(){s.room.socket.emit("token use",s.room.user.id,$(this).data("token"))}),this.order()},Users.prototype.destroy=function(){this.room.socket.removeAllListeners("user login"),this.room.socket.removeAllListeners("user logout"),this.room.socket.removeAllListeners("typing start"),this.room.socket.removeAllListeners("typing stop"),this.$users.off(".sortable"),$("body").off(".token").off(".sortable")};
//# sourceMappingURL=all.min.js.map
