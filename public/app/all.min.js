function Chat(t,e){this.msgbox=0,this.room=t,this.messages=[],this.myMessages=[],this.typing=null,this.editMode=-1,this.$messages=$("#messages"),this.$message=$("#message"),this.$content=$("#content"),this.$chat=$("#chat"),this.init(e)}function Dice2D(t,e,s,i){this.id=t,this.type=e,this.value=parseInt(this.type.replace("d","").split(" ")[0]),this.box=i,this.radius=.25*this.box.scale,this.color=s,this.transform,this.position={x:0,y:0,z:0},this.rotation=0,this.time=0,this.createMesh()}function Dices2D(t,e,s){this.room=t,this.w=e,this.h=s,this.cw,this.ch,this.scale,this.scene,this.dices={},this.init()}function copyto(t,e){if(null==t||"object"!=typeof t)return t;if(t instanceof Array)for(var s=t.length-1;s>=0;--s)e[s]=copy(t[s]);else for(var s in t)t.hasOwnProperty(s)&&(e[s]=copy(t[s]));return e}function copy(t){return t?copyto(t,new t.constructor):t}function makeGeometry(t,e,s,i,o){for(var a=new THREE.Geometry,r=0;r<t.length;++r){var n=(new THREE.Vector3).fromArray(t[r]).normalize().multiplyScalar(s);n.index=a.vertices.push(n)-1}for(var r=0;r<e.length;++r)for(var h=e[r],c=h.length-1,l=2*Math.PI/c,u=0;u<c-2;++u)a.faces.push(new THREE.Face3(h[0],h[u+1],h[u+2],[a.vertices[h[0]],a.vertices[h[u+1]],a.vertices[h[u+2]]],0,h[c]+1)),a.faceVertexUvs[0].push([new THREE.Vector2((Math.cos(o)+1+i)/2/(1+i),(Math.sin(o)+1+i)/2/(1+i)),new THREE.Vector2((Math.cos(l*(u+1)+o)+1+i)/2/(1+i),(Math.sin(l*(u+1)+o)+1+i)/2/(1+i)),new THREE.Vector2((Math.cos(l*(u+2)+o)+1+i)/2/(1+i),(Math.sin(l*(u+2)+o)+1+i)/2/(1+i))]);return a.computeFaceNormals(),a.computeVertexNormals(),a.boundingSphere=new THREE.Sphere(new THREE.Vector3,s),a}function idealTextColor(t){var e=105,s=getRGBComponents(t),i=.299*s.R+.587*s.G+.114*s.B;return 255-i<e?"#000000":"#ffffff"}function getRGBComponents(t){var e=t.substring(1,3),s=t.substring(3,5),i=t.substring(5,7);return{R:parseInt(e,16),G:parseInt(s,16),B:parseInt(i,16)}}function makeDiceMaterials(t,e,s,i){function o(t,e,o){if(void 0==t)return null;var a=document.createElement("canvas"),r=a.getContext("2d");a.width=s+i,a.height=s+i,r.font=s+"pt Arial",r.fillStyle=o,r.fillRect(0,0,a.width,a.height),r.textAlign="center",r.textBaseline="middle",r.fillStyle=e,r.fillText(t,a.width/2,a.height/2),"6"!=t&&"9"!=t||r.fillText("  .",a.width/2,a.height/2);var n=new THREE.Texture(a);return n.needsUpdate=!0,n}for(var a=[],r=0;r<e.length;++r)a.push(new THREE.MeshPhongMaterial(copyto(materialOptions,{map:o(e[r],idealTextColor(t),t)})));return a}function makeD4Materials(t,e,s){function i(t,i,o){var a=document.createElement("canvas"),r=a.getContext("2d");a.width=e+s,a.height=e+s,r.font=e+"pt Arial",r.fillStyle=o,r.fillRect(0,0,a.width,a.height),r.textAlign="center",r.textBaseline="middle",r.fillStyle=i,r.translate(0,e/10);for(var n in t)r.fillText(t[n],a.width/2,a.height/2-e-s/10),r.translate(a.width/2,a.height/2),r.rotate(2*Math.PI/3),r.translate(-a.width/2,-a.height/2);var h=new THREE.Texture(a);return h.needsUpdate=!0,h}for(var o=[],a=[[],[0,0,0],[2,4,3],[1,3,4],[2,1,4],[1,2,3]],r=0;r<a.length;++r)o.push(new THREE.MeshPhongMaterial(copyto(materialOptions,{map:i(a[r],idealTextColor(t),t)})));return o}function Dice3D(t,e,s,i){this.id=t,this.type=e,this.box=i,this.radius=.6*DicesModels3D[this.type].scale*i.scale,this.color=s,this.transform,this.createMesh(),this.box.renderer.render(this.box.scene,this.box.camera)}function Dices3D(t,e,s){this.room=t,this.w=e,this.h=s,this.cw,this.ch,this.scene,this.camera,this.renderer,this.aspect,this.scale,this.desk,this.light,this.dices={},this.init()}function Dice(t){this.type=t,this.rolls=0,this.cooldown=null,this.$item=$('<div class="dice d'+t.split("d").pop()+' noselect">'+t+"</div>")}function Dices(t,e){this.room=t,this.defaultDices=e||[],this.dices=[],this.$dices=$("#dices"),this.reset(),this.init()}function Images(t){this.room=t,this.image="",this.$zoom=null,this.init()}function LocalPlayer(t){this.music=t,this.audio=new Audio,this.volet=0,this.init()}function YoutubePlayer(t){this.music=t,this.index=0,this.youtube,this.$musicUrl,this.$playLater,this.$playNow,this.init()}function Music(t){this.room=t,this.playlist=[],this.current=0,this.savedVolume=0,this.currentVolume=0,this.localPlayer,this.youtubePlayer,this.player,this.$play=$("#play"),this.$mute=$("#mute"),this.$volume=$("#volume"),this.$bar=this.$volume.find(".audio-volume-bar"),this.$musicPlayer=$("#music-player"),this.$musicPopin,this.init()}function Room(t,e,s,i,o,a){this.socket=t,this.name=e,this.user=s,this.dices=new Dices(this,a.defaultDices),hasWebGLSupport()?this.dice=new Dices3D(this,window.innerWidth,window.innerHeight):this.dice=new Dices2D(this,window.innerWidth,window.innerHeight),this.users=new Users(this,i),this.images=new Images(this),this.chat=new Chat(this,o),this.music=new Music(this),this.options=a,this.$roomName=$("#room-name"),this.$logout=$("#logout"),this.init(i)}function Users(t,e){this.room=t,this.users=[],this.grabbed=null,this.ghost=null,this.$users=$("#users"),this.item,this.init(e)}Chat.prototype.getMessageIndexById=function(t){for(var e=this.messages.length-1;e>=0;e--)if(this.messages[e].id==t)return e;return-1},Chat.prototype.addMessage=function(t,e){t.user.name==this.room.user.name&&e&&this.myMessages.push(t),this.messages.push(t)},Chat.prototype.getClass=function(t){var e="";return t.user.name==this.room.user.name&&(e+=" me"),t.user.admin&&(e+=" admin"),t.prive&&(e+=" prive"),e},Chat.prototype.isNewBox=function(t){return!(this.messages.length>0&&this.messages[this.messages.length-1].user.name==t.user.name&&!this.messages[this.messages.length-1].command&&!this.messages[this.messages.length-1].image&&this.messages[this.messages.length-1].prive==t.prive)},Chat.prototype.showCommand=function(t){switch(t.command){case"/roll":this.$messages.append($('<li id="msgbox-'+ ++this.msgbox+'" class="diceroll mui-panel'+this.getClass(t)+'">').html('<span class="user">'+(t.prive?t.user.name+" to "+t.prive:t.user.name)+":</span> "+t.message)),this.addMessage(t,!1),this.room.users.showLastDice(t.user,t.message),t.user.name==this.room.user.name&&this.room.dices.roll(t.dice)}return this.$content.scrollTop(this.$content[0].scrollHeight),!0},Chat.prototype.showError=function(t){t.user.name="error",this.$messages.append($('<li id="msgbox-'+ ++this.msgbox+'" class="message '+t.error+' me">').html(t.message)),this.addMessage(t,!1),this.$content.scrollTop(this.$content[0].scrollHeight)},Chat.prototype.showImage=function(t){var e='<div id="image-'+t.image+'"><a href="#" data-image="'+t.image+'">Download image '+t.name+"</a></div>";this.isNewBox(t)?this.$messages.append('<li id="msgbox-'+ ++this.msgbox+'" class="message mui-panel'+this.getClass(t)+'"><div class="user">'+(t.prive?t.user.name+" to "+t.prive:t.user.name)+':</div> <div class="text">'+e+"</div></li>"):$("#msgbox-"+this.msgbox).find(".text").append(e),this.addMessage(t,!1),this.$content.scrollTop(this.$content[0].scrollHeight)},Chat.prototype.message=function(t){return t.error?void this.showError(t):t.command?void this.showCommand(t):"undefined"!=typeof t.image?void this.showImage(t):(this.isNewBox(t)?this.$messages.append('<li id="msgbox-'+ ++this.msgbox+'" class="message mui-panel'+this.getClass(t)+'"><div class="user">'+(t.prive?t.user.name+" to "+t.prive:t.user.name)+':</div> <div class="text"><div id="msg-'+t.id+'">'+t.message+"</div></div></li>"):$("#msgbox-"+this.msgbox).find(".text").append('<div id="msg-'+t.id+'">'+t.message+"</div>"),this.addMessage(t,!0),void this.$content.scrollTop(this.$content[0].scrollHeight))},Chat.prototype.editMessage=function(t){if(!(t.error||t.command||t.image)){var e=this.getMessageIndexById(t.id);if(e>=0){var s=this.myMessages.indexOf(this.messages[e]);s>=0&&(this.myMessages[s]=t),this.messages[e]=t,$("#msg-"+t.id).html(t.message)}}},Chat.prototype.typingStart=function(){var t=this;this.typing?(clearTimeout(this.typing),this.typing=setTimeout(function(){t.typingStop()},2500)):(this.room.socket.emit("typing start"),this.typing=setTimeout(function(){t.typingStop()},2500))},Chat.prototype.typingStop=function(){clearTimeout(this.typing),this.typing=null,this.room.socket.emit("typing stop")},Chat.prototype.startEdit=function(){if(this.editMode>=0){var t=this;this.$message.focus(),this.$message.val(this.myMessages[this.editMode].message),setTimeout(function(){t.$message.putCursorAtEnd()},0)}},Chat.prototype.stopEdit=function(){this.editMode>=0&&(this.$message.val(""),this.editMode=-1)},Chat.prototype.editPrev=function(){this.editMode<=0&&(this.editMode=this.myMessages.length),--this.editMode,this.startEdit()},Chat.prototype.editNext=function(){++this.editMode,this.editMode>=this.myMessages.length?this.stopEdit():this.startEdit()},Chat.prototype.checkEndEdit=function(){""==this.$message.val()&&(this.editMode=-1)},Chat.prototype.init=function(t){var e=this;for(i=0,length=t.length;i<length;i++)this.message(t[i]);this.$chat.on("submit.chat",function(t){t.preventDefault();var s=e.$message.val();if(""!=s){if(e.editMode>=0){var i=e.myMessages[e.editMode];i.prive&&(s="@"+i.prive+" "+s),e.room.socket.emit("chat edit",i.id,s),e.stopEdit()}else e.room.socket.emit("chat",s);e.$message.val(""),e.checkEndEdit(),e.typingStop()}return!1}),this.room.socket.on("chat",function(t){e.message(t)}),this.$message.on("keypress.chat",function(t){8!=t.keyCode&&13!=t.keyCode&&e.typingStart()}),this.room.socket.on("chat edit",function(t){e.editMessage(t)}),this.$message.on("keydown.chat",function(t){38==t.keyCode?e.editPrev():40==t.keyCode?e.editNext():8!=t.keyCode&&46!=t.keyCode||e.checkEndEdit()})},Chat.prototype.destroy=function(){this.$chat.off(".chat"),this.$message.off(".chat"),this.room.socket.removeAllListeners("chat"),this.room.socket.removeAllListeners("chat edit")},Dice2D.prototype.createMesh=function(){this.transform=$('<div class="dice '+this.type+'"></div>').css({position:"absolute",top:-this.radius,left:-this.radius,width:2*this.radius,height:2*this.radius,lineHeight:2*this.radius+"px",fontSize:.75*this.radius+"px",fontWeight:"bold",textShadow:"2px 2px 0px #000000, 2px -2px 0px #000000, -2px -2px 0px #000000, -2px 2px 0px #000000"}),this.box.scene.append(this.transform)},Dice2D.prototype.update=function(t){this.position.x=t[0]*this.box.w/1e3/2+this.box.cw,this.position.y=this.box.ch-t[1]*this.box.h/1e3/2,this.position.z=t[2],this.rotation=(2*Math.acos(t[3])*180/Math.PI+180)%360,this.transform.css("transform","translate3d("+this.position.x+"px, "+this.position.y+"px, "+this.position.z+"px) rotate("+this.rotation+"deg)"),Date.now()-this.time>166&&(this.transform.html(Math.ceil(Math.random()*this.value)),this.time=Date.now())},Dice2D.prototype.result=function(t){this.transform.html(t)},Dice2D.prototype.remove=function(){this.transform.remove(),delete this.box.dices[this.id]},Dices2D.prototype.init=function(){var t=this;this.cw=this.w/2,this.ch=this.h/2,this.scale=Math.sqrt(this.w*this.w+this.h*this.h)/13,this.dices={},this.scene=$("#dice-box"),this.room.socket.on("dice start",function(e){for(var s=0;s<e.length;s++)t.dices[e[s].id]=new Dice2D(e[s].id,e[s].type,e[s].color,t)}),this.room.socket.on("dice update",function(e){for(var s in e)t.dices[s]&&t.dices[s].update(e[s])}),this.room.socket.on("dice result",function(e){for(var s in e)t.dices[s]&&t.dices[s].result(e[s])}),this.room.socket.on("dice end",function(e){for(var s=0;s<e.length;s++)t.dices[e[s]]&&t.dices[e[s]].remove()})},Dices2D.prototype.remove=function(){this.room.socket.removeAllListeners("dice start"),this.room.socket.removeAllListeners("dice update"),this.room.socket.removeAllListeners("dice result"),this.room.socket.removeAllListeners("dice end")};var DicesModels3D={};DicesModels3D.d4={geometry:{vertices:[[1,1,1],[-1,-1,1],[-1,1,-1],[1,-1,-1]],faces:[[1,0,2,1],[0,1,3,2],[0,3,2,3],[1,2,3,4]],tab:-.1,af:7*Math.PI/6},mass:300,inertia:5,scale:1},DicesModels3D.d6={geometry:{vertices:[[-1,-1,-1],[1,-1,-1],[1,1,-1],[-1,1,-1],[-1,-1,1],[1,-1,1],[1,1,1],[-1,1,1]],faces:[[0,3,2,1,1],[1,2,6,5,2],[0,1,5,4,3],[3,7,6,2,4],[0,4,7,3,5],[4,5,6,7,6]],tab:.1,af:Math.PI/4},mass:300,inertia:13,scale:1.1},DicesModels3D.d8={geometry:{vertices:[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1]],faces:[[0,2,4,1],[0,4,3,2],[0,3,5,3],[0,5,2,4],[1,3,4,5],[1,4,2,6],[1,2,5,7],[1,5,3,8]],tab:0,af:-Math.PI/4/2},mass:340,inertia:10,scale:1.1},DicesModels3D.d10={geometry:{vertices:function(){for(var t=2*Math.PI/10,e=(Math.cos(t),.105),s=[],i=0,o=0;i<10;++i,o+=t)s.push([Math.cos(o),Math.sin(o),e*(i%2?1:-1)]);return s.push([0,0,-1]),s.push([0,0,1]),s}(),faces:[[5,7,11,0],[4,2,10,1],[1,3,11,2],[0,8,10,3],[7,9,11,4],[8,6,10,5],[9,1,11,6],[2,0,10,7],[3,5,11,8],[6,4,10,9],[5,6,7,-1],[3,2,4,-1],[1,2,3,-1],[9,8,0,-1],[7,8,9,-1],[7,6,8,-1],[9,0,1,-1],[1,0,2,-1],[3,4,5,-1],[5,4,6,-1]],tab:0,af:6*Math.PI/5},mass:350,inertia:9,scale:1},DicesModels3D.d12={geometry:{vertices:function(){var t=(1+Math.sqrt(5))/2,e=1/t;return[[0,e,t],[0,e,-t],[0,-e,t],[0,-e,-t],[t,0,e],[t,0,-e],[-t,0,e],[-t,0,-e],[e,t,0],[e,-t,0],[-e,t,0],[-e,-t,0],[1,1,1],[1,1,-1],[1,-1,1],[1,-1,-1],[-1,1,1],[-1,1,-1],[-1,-1,1],[-1,-1,-1]]}(),faces:[[2,14,4,12,0,1],[15,9,11,19,3,2],[16,10,17,7,6,3],[6,7,19,11,18,4],[6,18,2,0,16,5],[18,11,9,14,2,6],[1,17,10,8,13,7],[1,13,5,15,3,8],[13,8,12,4,5,9],[5,4,14,9,15,10],[0,12,8,10,16,11],[3,19,7,17,1,12]],tab:.2,af:-Math.PI/4/2},mass:380,inertia:8,scale:1},DicesModels3D.d20={geometry:{vertices:function(){var t=(1+Math.sqrt(5))/2;return[[-1,t,0],[1,t,0],[-1,-t,0],[1,-t,0],[0,-1,t],[0,1,t],[0,-1,-t],[0,1,-t],[t,0,-1],[t,0,1],[-t,0,-1],[-t,0,1]]}(),faces:[[0,11,5,1],[0,5,1,2],[0,1,7,3],[0,7,10,4],[0,10,11,5],[1,5,9,6],[5,11,4,7],[11,10,2,8],[10,7,6,9],[7,1,8,10],[3,9,4,11],[3,4,2,12],[3,2,6,13],[3,6,8,14],[3,8,9,15],[4,9,5,16],[2,4,11,17],[6,2,10,18],[8,6,7,19],[9,8,1,20]],tab:-.2,af:-Math.PI/4/2},mass:400,inertia:6,scale:1},DicesModels3D.d100={geometry:DicesModels3D.d10.geometry,mass:350,inertia:9,scale:1};var materialOptions={specular:"#171d1f",color:"#ffffff",emissive:"#000000",shininess:7,shading:THREE.FlatShading},diceLabels=[" ","0","1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20"],d10Labels=[" ","1","2","3","4","5","6","7","8","9","0"],d100Labels=[" ","10","20","30","40","50","60","70","80","90","00"];Dice3D.prototype.createMesh=function(){var t,e=DicesModels3D[this.type],s=makeGeometry(e.geometry.vertices,e.geometry.faces,this.radius,e.geometry.tab,e.geometry.af);t="d4"==this.type?makeD4Materials(this.color,this.box.scale/3,this.box.scale):"d100"==this.type?makeDiceMaterials(this.color,d100Labels,this.box.scale/3,this.box.scale):"d10"==this.type?makeDiceMaterials(this.color,d10Labels,this.box.scale/3,this.box.scale):makeDiceMaterials(this.color,diceLabels,this.box.scale/3,this.box.scale);var i=new THREE.Mesh(s,new THREE.MeshFaceMaterial(t));i.castShadow=!0,i.receiveShadow=!1,i.position.x=2*-this.box.w,i.position.y=2*-this.box.h,i.position.z=0,i.quaternion.x=0,i.quaternion.y=0,i.quaternion.z=0,i.quaternion.w=0,this.transform=i,this.box.scene.add(i)},Dice3D.prototype.update=function(t){this.transform.position.x=t[0]*this.box.w/1e3,this.transform.position.y=t[1]*this.box.h/1e3,this.transform.position.z=t[2],this.transform.quaternion.x=t[3],this.transform.quaternion.y=t[4],this.transform.quaternion.z=t[5],this.transform.quaternion.w=t[6]},Dice3D.prototype.remove=function(){this.box.scene.remove(this.transform),delete this.box.dices[this.id]},Dices3D.prototype.resize=function(){this.w=window.innerWidth,this.h=window.innerHeight,this.cw=this.w/2,this.ch=this.h/2,this.aspect=Math.min(this.cw/this.w,this.ch/this.h),this.scale=Math.sqrt(this.w*this.w+this.h*this.h)/13;var t=Math.min(this.cw,this.ch)/this.aspect/Math.tan(10*Math.PI/180);this.camera.aspect=this.cw/this.ch,this.camera.far=1.3*t,this.camera.position.z=t,this.camera.updateProjectionMatrix();var e=Math.max(this.w,this.h);this.light.position.set(-e/2,e/2,2*e),this.light.target.position.set(0,0,0),this.renderer.setSize(this.w,this.h)},Dices3D.prototype.init=function(){var t=this;this.cw=this.w/2,this.ch=this.h/2,this.aspect=Math.min(this.cw/this.w,this.ch/this.h),this.scale=Math.sqrt(this.w*this.w+this.h*this.h)/13,this.renderer=window.WebGLRenderingContext?new THREE.WebGLRenderer({antialias:!0,alpha:!0}):new THREE.CanvasRenderer({antialias:!0,alpha:!0}),this.renderer.setSize(2*this.cw,2*this.ch),this.renderer.shadowMapEnabled=!0,this.renderer.shadowMapSoft=!0,this.renderer.setClearColor(0,0),this.dices={},this.scene=new THREE.Scene,this.scene.fog=null,$("#dice-box").append(this.renderer.domElement);var e=Math.min(this.cw,this.ch)/this.aspect/Math.tan(10*Math.PI/180);this.camera=new THREE.PerspectiveCamera(20,this.cw/this.ch,1,1.3*e),this.camera.position.z=e;var s=new THREE.AmbientLight(6710886);this.scene.add(s);var i=Math.max(this.w,this.h);this.light=new THREE.SpotLight(16777215),this.light.position.set(-i/2,i/2,2*i),this.light.target.position.set(0,0,0),this.light.castShadow=!0,this.light.shadowCameraNear=i/10,this.light.shadowCameraFar=3*i,this.light.shadowCameraFov=50,this.light.shadowBias=.001,this.light.shadowDarkness=.3,this.light.shadowMapWidth=1024,this.light.shadowMapHeight=1024,this.scene.add(this.light);var o=["uniform vec3 diffuse;","uniform float opacity;",THREE.ShaderChunk.color_pars_fragment,THREE.ShaderChunk.map_pars_fragment,THREE.ShaderChunk.lightmap_pars_fragment,THREE.ShaderChunk.envmap_pars_fragment,THREE.ShaderChunk.fog_pars_fragment,THREE.ShaderChunk.shadowmap_pars_fragment,THREE.ShaderChunk.specularmap_pars_fragment,"void main() {","gl_FragColor = vec4( 1.0, 1.0, 1.0, 1.0 );",THREE.ShaderChunk.map_fragment,THREE.ShaderChunk.alphatest_fragment,THREE.ShaderChunk.specularmap_fragment,THREE.ShaderChunk.lightmap_fragment,THREE.ShaderChunk.color_fragment,THREE.ShaderChunk.envmap_fragment,THREE.ShaderChunk.shadowmap_fragment,THREE.ShaderChunk.linear_to_gamma_fragment,THREE.ShaderChunk.fog_fragment,"gl_FragColor = vec4( 0.0, 0.0, 0.0, 1.0 - shadowColor.x );","}"].join("\n"),a=new THREE.ShaderMaterial({uniforms:THREE.ShaderLib.basic.uniforms,vertexShader:THREE.ShaderLib.basic.vertexShader,fragmentShader:o,color:255});this.desk=new THREE.Mesh(new THREE.PlaneGeometry(2*this.w,2*this.h,1,1),a),this.desk.receiveShadow=!0,this.scene.add(this.desk),window.addEventListener("click",this.resize.bind(this)),this.room.socket.on("dice start",function(e){for(var s=0;s<e.length;s++)t.dices[e[s].id]=new Dice3D(e[s].id,e[s].type,e[s].color,t)}),this.room.socket.on("dice update",function(e){for(var s in e)t.dices[s]&&t.dices[s].update(e[s]);t.renderer.render(t.scene,t.camera)}),this.room.socket.on("dice end",function(e){for(var s=0;s<e.length;s++)t.dices[e[s]]&&t.dices[e[s]].remove();t.renderer.render(t.scene,t.camera)})},Dices3D.prototype.remove=function(){this.room.socket.removeAllListeners("dice start"),this.room.socket.removeAllListeners("dice update"),this.room.socket.removeAllListeners("dice end")},Dice.prototype.roll=function(){var t=this;++this.rolls,this.$item.addClass("cooldown"),clearTimeout(this.cooldown),this.cooldown=setTimeout(function(){t.$item.removeClass("cooldown")},2e3)},Dices.prototype.reset=function(){var t=this;this.dices=[],$.each(this.defaultDices,function(e,s){t.roll(s)})},Dices.prototype.show=function(){this.sort();var t=this.number(),e=this.dices.length>t?t:this.dices.length;this.$dices.children(".dice").detach(),this.$dices[0].className="dices-"+e;for(var s=0;s<e;s++)this.$dices.append(this.dices[s].$item)},Dices.prototype.sort=function(){this.dices.sort(function(t,e){return e.rolls-t.rolls})},Dices.prototype.roll=function(t){t=t.split("d"),"1"==t[0]&&(t[0]=""),t=t.join("d");for(var e=!1,s=this.dices.length-1;s>=0;s--)if(this.dices[s].type==t){e=!0,this.dices[s].roll();break}e||this.dices.push(new Dice(t)),this.show()},Dices.prototype.number=function(){return Math.max(Math.min(Math.round(.15*$(window).width()/40),5),1)},Dices.prototype.init=function(){var t=this;$(window).on("resize.dices",function(){t.show()}),$(document).on("click.dices",".dice",function(e){e.preventDefault();var s=$(this);if(!s.hasClass("cooldown")){s.addClass("cooldown");var i=s.html();t.room.socket.emit("chat","/roll "+i)}})},Dices.prototype.destroy=function(){$(window).off(".dices"),$(document).off(".dices")},Images.prototype.show=function(t){$("#image-"+t.id).html('<img class="zoomable link" src="'+t.url+'" alt="'+t.name+'" title="'+t.name+'">')},Images.prototype.close=function(){this.$zoom&&(this.$zoom.off(".images"),this.$zoom.remove(),this.$zoom=null)},Images.prototype.zoom=function(t){if(!this.$zoom){var e=this;this.$zoom=$('<div class="overlay centerer closable"><div class="image centered"><img class="zoomed" src="'+t+'" alt=""></div></div>'),$("body").append(this.$zoom),this.$zoom.on("click.images",function(){e.close()})}},Images.prototype.upload=function(t){if("image"==t.type.split("/").shift()){var e=this;reader=new FileReader,reader.onload=function(s){e.room.socket.emit("image upload",t.name,s.target.result)},reader.readAsDataURL(t)}},Images.prototype.download=function(t){this.room.socket.emit("image download",t)},Images.prototype.init=function(){var t=this;$("body").on("dragover.images",function(t){t.preventDefault()}).on("drop.images",function(e){e.preventDefault(),t.upload(e.originalEvent.dataTransfer.files[0])}).on("click.images",".zoomable",function(e){e.preventDefault(),t.zoom($(this).attr("src"))}).on("click.images","[data-image]",function(e){e.preventDefault(),$(this).append(' <i class="fa fa-spin fa-refresh"></i>'),t.download($(this).attr("data-image"))}),this.room.socket.on("image",function(e){t.show(e)})},Images.prototype.destroy=function(){this.close(),$("body").off(".images")},function(){function t(t,e,s,i){return""!=e&&""!=s&&!h&&(h=!0,t.append('<span id="loading">&nbsp;&nbsp;<i class="fa fa-spin fa-refresh"></i></span>'),void n.emit(i,{room:e,user:s}))}function e(){return t($("#join"),$("#room").val(),$("#user").val(),"room join"),!1}function s(){return t($("#create"),$("#room").val(),$("#user").val(),"room create"),!1}function i(){n.on("login",function(t){return h=!1,$("#loading").remove(),t.succes?(o=new Room(n,t.room.name,t.user,t.room.users,t.room.messages,t.room.settings),Cookies.set("login",t.room.name+"|"+t.user.name,{expires:356}),void $(".login-wrapper").fadeOut(300)):void $("#login-msg").html(t.error).addClass("error")}),$("#login").submit(e),$("#join").click(e),$("#create").click(s);var i=Cookies.get("login");if(i){var a=i.split("|");t($("#join"),a[0],a[1],"room join")}}var o,a=Config||{},r=a.url||"http://localhost:3030",n=io(r),h=!1;window.addEventListener("DOMContentLoaded",i)}(),LocalPlayer.prototype.init=function(){var t=this;document.body.appendChild(this.audio),this.audio.autoplay=!0,this.audio.loop=!0,t.music.room.user.admin&&$.post("music/list.php",function(e){t.music.$musicPopin.find(".local-contener").append(t.crawlSongs(e)),$("body").on("click.music",".song .fa-play",function(e){e.preventDefault(),t.song($(this).parent().parent(),!1)}),$("body").on("click.music",".song .fa-plus",function(e){e.preventDefault(),t.song($(this).parent().parent(),!0)}),$("body").on("click.music",".playlist .fa-play",function(e){e.preventDefault(),t.playlist($(this).parent().parent(),!1)}),$("body").on("click.music",".playlist .fa-plus",function(e){e.preventDefault(),t.playlist($(this).parent().parent(),!0)})})},LocalPlayer.prototype.song=function(t,e){var s=this;s.music.$musicPopin.fadeOut(300);var i={type:"local",add:e,url:[t.attr("data-song")]};s.music.room.socket.emit("music",i)},LocalPlayer.prototype.playlist=function(t,e){var s=this,i={type:"local",add:e,url:[]};s.music.$musicPopin.fadeOut(300),t.next("input").next("label").next("ul").find(".song").each(function(){i.url.push($(this).attr("data-song"))}),s.music.room.socket.emit("music",i)},LocalPlayer.prototype.crawlSongs=function(t){++this.volet;var e="";e+='<h4 class="playlist list link">'+t.title+'<span class="icon-play"><i class="fa fa-plus"></i><i class="fa fa-play"></i></span></h4>',e+='<input id="volet-'+this.volet+'" type="checkbox" '+(1==this.volet?"checked":"")+' class="volet-checkbox">',e+='<label for="volet-'+this.volet+'" class="volet-btn link fa fa-caret-right"></label>',e+='<ul class="volet-content">';for(var s=0;s<t.songs.length;s++)e+="playlist"==t.songs[s].type?"<li>"+this.crawlSongs(t.songs[s])+"</li>":'<li class="song list link" data-song="music/'+t.songs[s].url+'">'+t.songs[s].title+'<span class="icon-play"><i class="fa fa-plus"></i><i class="fa fa-play"></i></span></li>';return e+="</ul>"},LocalPlayer.prototype.start=function(t){this.audio.src=t.url,this.play()},LocalPlayer.prototype.pause=function(){this.audio.pause()},LocalPlayer.prototype.play=function(){this.audio.play()},LocalPlayer.prototype.volume=function(t){this.audio.volume=Math.max(0,Math.min(t,1))},LocalPlayer.prototype.destroy=function(){console.log(this.audio),this.audio.parentNode.removeChild(this.audio)},YoutubePlayer.prototype.init=function(){function t(t){console.log("player ready"),s.music.room.user.admin&&(s.music.$musicPopin.find(".youtube-contener").append('<div class="mui-form-group"><input id="music-url" type="text" class="mui-form-control" placeholder="https://www.youtube.com/watch?v=KqeKikpLQ5o"><label>Youtube url</label></div><button id="play-later" class="mui-btn mui-btn-flat mui-btn-default mui-pull-left">To playlist</button><button id="play-now" class="mui-btn mui-btn-raised mui-btn-primary mui-pull-right">Play now</button>'),s.$musicUrl=$("#music-url"),s.$playLater=$("#play-later"),s.$playNow=$("#play-now"),s.$playNow.on("click.music",function(t){t.preventDefault();var e=s.$musicUrl[0].value,i=s.parseURL(e);i.add=!1,s.music.$musicPopin.fadeOut(300),s.music.room.socket.emit("music",i)}),s.$playLater.on("click.music",function(t){t.preventDefault();var e=s.$musicUrl[0].value,i=s.parseURL(e);i.add=!0,s.music.$musicPopin.fadeOut(300),s.music.room.socket.emit("music",i)}))}function e(t){t.data==YT.PlayerState.PLAYING&&(s.index=t.target.getPlaylistIndex()),t.data==YT.PlayerState.ENDED&&s.index==t.target.getPlaylist().length-1&&s.music.next()}var s=this,i=document.createElement("script");i.src="https://www.youtube.com/iframe_api";var o=document.getElementsByTagName("script")[0];o.parentNode.insertBefore(i,o),window.onYouTubeIframeAPIReady=function(){s.youtube=new YT.Player("yt-player",{height:"1",width:"1",events:{onReady:t,onStateChange:e}})}},YoutubePlayer.prototype.parseURL=function(t){var e="video";return t.indexOf("list=")!=-1?(t=t.replace(/(>|<)/gi,"").split(/(vi\/|list=|\/v\/|youtu\.be\/|\/embed\/)/),e="playlist"):t=t.replace(/(>|<)/gi,"").split(/(vi\/|v=|\/v\/|youtu\.be\/|\/embed\/)/),void 0!==t[2]&&(t=t[2].split(/[^0-9a-z_\-]/i)),{url:t[0],type:e}},YoutubePlayer.prototype.start=function(t){"playlist"==t.type?this.youtube.loadPlaylist({list:t.url}):this.youtube.loadPlaylist(t.url)},YoutubePlayer.prototype.pause=function(){this.youtube.pauseVideo()},YoutubePlayer.prototype.play=function(){this.youtube.playVideo()},YoutubePlayer.prototype.volume=function(t){this.youtube.setVolume(100*Math.max(0,Math.min(t,1)))},YoutubePlayer.prototype.destroy=function(){this.youtube.destroy(),this.music.room.user.admin&&(this.$playNow.off(".music"),this.$playLater.off(".music"))},Music.prototype.load=function(t){if(console.log("data",t),t.add){if("local"==t.type)for(var e=0,s=t.url.length;e<s;e++)this.playlist.push({type:t.type,add:t.add,url:t.url[e]});else this.playlist.push(t);1==this.playlist.length&&(this.current=0,this.start())}else{if(this.playlist=[],"local"==t.type)for(var e=0,s=t.url.length;e<s;e++)this.playlist.push({type:t.type,add:t.add,url:t.url[e]});else this.playlist.push(t);this.current=0,this.start()}},Music.prototype.start=function(){console.log(this.playlist),0!==this.playlist.length&&("local"==this.playlist[this.current].type?this.player=this.localPlayer:this.player=this.youtubePlayer,this.player.start(this.playlist[this.current]),this.play())},Music.prototype.next=function(){++this.current>=this.playlist.length&&(this.current=0),this.start()},Music.prototype.play=function(){this.$play.removeClass("fa-play").addClass("fa-pause"),this.player.play(),this.volume(this.currentVolume)},Music.prototype.pause=function(){this.$play.removeClass("fa-pause").addClass("fa-play"),this.player.pause()},Music.prototype.volume=function(t){t=Math.min(Math.max(t,0),1);var e="fa ";e+=0==t?"fa-volume-off":t<.4?"fa-volume-down":"fa-volume-up",this.$mute[0].className=e,this.$bar.css("width",100*t+"%"),this.player&&this.player.volume(.2*t),this.currentVolume=t},Music.prototype.mute=function(){this.savedVolume=this.currentVolume,this.volume(0)},Music.prototype.unmute=function(){this.volume(this.savedVolume),this.savedVolume=0},Music.prototype.init=function(){var t=this;t.youtubePlayer=new YoutubePlayer(t),t.localPlayer=new LocalPlayer(t),t.volume(.5),t.$volume.on("mousedown.music",function(e){e.preventDefault(),t.volume(Math.round(e.offsetX/$(this).width()*100)/100),$(window).on("mousemove.music",function(e){var s=e.clientX-t.$volume.offset().left;t.volume(Math.round(s/t.$volume.width()*100)/100)})}),t.$mute.on("click.music",function(){0==t.savedVolume?t.mute():t.unmute()}),$(window).on("mouseup.music",function(){$(window).off("mousemove.music")}),t.room.socket.on("music",function(e){t.load(e)}),t.room.socket.on("music pause",function(){t.pause()}),t.room.socket.on("music play",function(){t.play()}),t.room.socket.on("music volume",function(e){t.volume(e)}),t.room.user.admin&&($(".room-wrapper").append('<div id="music-player"><div class="music-title">Click to choose song</div></div>'),$(".room-wrapper").append('<div class="music-selector overlay centerer" style="display:none;"><div class="popin mui-panel centered"><i class="music-selector-close fa fa-times link"></i><div class="youtube-contener"></div><div class="local-contener" style="position:relative;clear:both;"></div></div></div>'),t.$musicPlayer=$("#music-player"),t.$musicPopin=$(".music-selector"),t.$musicPlayer.on("click.music",function(e){e.preventDefault(),t.room.user.admin&&t.$musicPopin.fadeIn(300)}),t.$play.on("click.music",function(e){if(e.preventDefault(),t.room.user.admin){var s=$(this);s.hasClass("fa-play")?t.player?t.room.socket.emit("music play"):t.$musicPopin.fadeIn(300):t.room.socket.emit("music pause")}}),$("body").on("click.music",".music-selector-close",function(){t.$musicPopin.fadeOut(300)}))},Music.prototype.destroy=function(){this.youtubePlayer.destroy(),this.localPlayer.destroy(),this.$volume.off(".music"),this.$mute.off(".music"),this.$play.off(".music"),$("body").off(".music"),$(window).off(".music"),this.room.socket.removeAllListeners("music"),this.room.socket.removeAllListeners("music play"),this.room.socket.removeAllListeners("music pause"),this.room.socket.removeAllListeners("music volume"),this.room.user.admin&&(this.$musicPlayer.remove(),this.$musicPopin.remove())},function(t){if("function"==typeof define&&define.amd)define(t);else if("object"==typeof exports)module.exports=t();else{var e=window.Cookies,s=window.Cookies=t(window.jQuery);s.noConflict=function(){return window.Cookies=e,s}}}(function(){function t(){for(var t=0,e={};t<arguments.length;t++){var s=arguments[t];for(var i in s)e[i]=s[i]}return e}function e(s){function i(e,o,a){var r;if(arguments.length>1){if(a=t({path:"/"},i.defaults,a),"number"==typeof a.expires){var n=new Date;n.setMilliseconds(n.getMilliseconds()+864e5*a.expires),a.expires=n}try{r=JSON.stringify(o),/^[\{\[]/.test(r)&&(o=r)}catch(h){}return o=encodeURIComponent(String(o)),o=o.replace(/%(23|24|26|2B|3A|3C|3E|3D|2F|3F|40|5B|5D|5E|60|7B|7D|7C)/g,decodeURIComponent),e=encodeURIComponent(String(e)),e=e.replace(/%(23|24|26|2B|5E|60|7C)/g,decodeURIComponent),e=e.replace(/[\(\)]/g,escape),document.cookie=[e,"=",o,a.expires&&"; expires="+a.expires.toUTCString(),a.path&&"; path="+a.path,a.domain&&"; domain="+a.domain,a.secure?"; secure":""].join("")}e||(r={});for(var c=document.cookie?document.cookie.split("; "):[],l=/(%[0-9A-Z]{2})+/g,u=0;u<c.length;u++){var d=c[u].split("="),m=d[0].replace(l,decodeURIComponent),p=d.slice(1).join("=");'"'===p.charAt(0)&&(p=p.slice(1,-1));
try{if(p=s&&s(p,m)||p.replace(l,decodeURIComponent),this.json)try{p=JSON.parse(p)}catch(h){}if(e===m){r=p;break}e||(r[m]=p)}catch(h){}}return r}return i.get=i.set=i,i.getJSON=function(){return i.apply({json:!0},[].slice.call(arguments))},i.defaults={},i.remove=function(e,s){i(e,"",t(s,{expires:-1}))},i.withConverter=e,i}return e()}),jQuery.fn.putCursorAtEnd=function(){return this.each(function(){if($(this).focus(),this.setSelectionRange){var t=2*$(this).val().length;this.setSelectionRange(t,t)}else $(this).val($(this).val());this.scrollTop=999999})};var hasWebGLSupport=function(){var t=!1,e=!1;return function(){if(!e){var s=null,i=document.createElement("canvas");try{s=i.getContext("webgl")}catch(o){s=null}if(null==s)try{s=i.getContext("experimental-webgl"),experimental=!0}catch(o){s=null}t=!(null==s||!window.WebGLRenderingContext),i=null,e=!0}return t}}();Room.prototype.init=function(t){var e=this;this.$roomName.text(this.name),this.user.admin&&$("body").addClass("admin-layout"),this.$logout.on("click.room",function(t){t.preventDefault(),Cookies.remove("login"),e.destroy(),window.location.href=window.location.href}),this.socket.on("disconnect",function(){e.destroy(),window.location.href=window.location.href})},Room.prototype.destroy=function(){$("body").removeClass("admin-layout"),this.$roomName.text(""),this.$logout.off(".room"),this.dices.destroy(),this.users.destroy(),this.chat.destroy(),this.music.destroy()},Users.prototype.getUserByName=function(t){for(var e=this.users.length-1;e>=0;e--)if(this.users[e].name.toLowerCase()==t.toLowerCase())return this.users[e];return!1},Users.prototype.getUserById=function(t){for(var e=this.users.length-1;e>=0;e--)if(this.users[e].id==t)return this.users[e];return!1},Users.prototype.getIndexById=function(t){for(var e=this.users.length-1;e>=0;e--)if(this.users[e].id==t)return e;return-1},Users.prototype.showUser=function(t){var e="user";t.admin&&(e+=" admin"),t.name==this.room.user.name&&(e+=" me");var s='<div class="user-details mui-panel"><!--<div class="title"><strong>Characteristics</strong></div><div class="user-health noselect" data-carac="health"><i class="fa fa-heart"></i> <span>8</span></div><div class="user-defense noselect" data-carac="defense"><i class="fa fa-shield"></i> <span>8</span></div>--><div class="title"><strong>Tokens</strong></div><div class="user-tokens"></div></div>',i='<li data-user="'+t.id+'" data-sort="'+t.order+'" class="user-item '+e+'" id="user-'+t.id+'">'+t.name+'<span class="user-dice"></span>'+s+"</li>";t.admin?this.$users.prepend(i):this.$users.append(i),this.refreshTokens(t)},Users.prototype.addUser=function(t){t.admin?this.users.unshift(t):this.users.push(t),this.showUser(t),this.order()},Users.prototype.removeUser=function(t){var e=this.getIndexById(t.id);e>=0&&this.users.splice(e,1),$("#user-"+t.id).remove(),this.order()},Users.prototype.refreshTokens=function(t){if(u=this.getUserById(t.id),u){u.tokens=t.tokens;var e=$("#user-"+t.id+" .user-tokens"),s="";for(var i in u.tokens)s+='<div class="token '+i+'" data-user="'+t.id+'" data-token="'+i+'">'+u.tokens[i]+"</div>";""==s?e.html('<div class="notoken">No tokens</div>'):e.html(s)}},Users.prototype.typingStart=function(t){$("#user-"+t.id).addClass("typing")},Users.prototype.typingStop=function(t){$("#user-"+t.id).removeClass("typing")},Users.prototype.showLastDice=function(t,e){$("#user-"+t.id).find(".user-dice").html(e)},Users.prototype.grab=function(t,e){if(null===this.grabbed&&this.room.user.admin&&!t.hasClass("admin")){var s=this;$("body").addClass("grabbing"),this.ghost=t.clone().css({position:"absolute",top:"0",left:"0",width:t.outerWidth()+"px",transform:"translate("+e.x+"px, "+e.y+"px)"}).appendTo("body"),this.grabbed=t.addClass("grabbing"),$("body").on("mouseup.sortable",function(t){t.preventDefault(),s.release({x:t.pageX,y:t.pageY})}),$("body").on("mousemove.sortable",function(t){t.preventDefault(),s.grabbing({x:t.pageX,y:t.pageY})})}},Users.prototype.grabbing=function(t){if(null!==this.grabbed){var e=this;this.ghost.css("transform","translate("+t.x+"px, "+t.y+"px)"),this.items.each(function(){var s=$(this);if(!s.hasClass("grabbing")&&!s.hasClass("admin")){var i=s.offset().top,o=s.outerHeight();if(i<t.y&&t.y<i+o)return void(t.y>i+o/2?e.grabbed.after(s):e.grabbed.before(s))}})}},Users.prototype.release=function(){null!==this.grabbed&&($("body").removeClass("grabbing"),this.grabbed.removeClass("grabbing"),this.grabbed=null,this.ghost.remove(),this.ghost=null,$("body").off(".sortable"),this.room.user.admin&&this.ordering())},Users.prototype.order=function(){var t=this;this.items=this.$users.find(".user").sort(function(t,e){return parseInt($(t).data("sort"),10)-parseInt($(e).data("sort"),10)}).each(function(e){$(this).data("sort");t.$users.append($(this))})},Users.prototype.ordering=function(){var t={};this.items=this.$users.find(".user"),this.items.each(function(e){$(this).data("sort",e);var s=$(this).data("user");s&&e&&(t[s]=e)}),this.room.socket.emit("user order",t)},Users.prototype.sort=function(t){for(var e in t){e=parseInt(e,10);var s=this.getUserById(e);s&&(s.order=parseInt(t[e],10),$("#user-"+e).data("sort",t[e]))}this.order()},Users.prototype.init=function(t){for(var e=this,s=0,i=t.length;s<i;s++){var o=t[s];o.connected&&(o.name.toLowerCase()==this.room.user.name.toLowerCase()&&(o=this.room.user),this.addUser(o),this.refreshTokens(o))}this.room.socket.on("user login",function(t){e.addUser(t)}),this.room.socket.on("user logout",function(t){e.removeUser(t)}),this.room.socket.on("typing start",function(t){e.typingStart(t)}),this.room.socket.on("typing stop",function(t){e.typingStop(t)}),this.room.socket.on("token give",function(t){e.refreshTokens(t)}),this.room.socket.on("token use",function(t,s){e.refreshTokens(t);var s=$('<div id="token-popin-'+t.id+'" class="before overlay centerer"><div class="popin centered mui-panel text-align-center"><h3>'+t.name+" use "+s+' token</h3><div class="'+s+' token big">&nbsp;</div></div></div>');$("body").append(s),s.delay(2e3).fadeOut(300,function(){$("#token-popin-"+t.id).remove()}),setTimeout(function(){s.removeClass("before")})}),this.room.socket.on("user order",function(t){e.sort(t)}),this.room.user.admin?(this.$users.on("mousedown.sortable",".user-details",function(t){t.preventDefault(),t.stopPropagation()}),this.$users.on("mousedown.sortable",".user",function(t){t.preventDefault(),e.grab($(this),{x:t.pageX,y:t.pageY})}),$("body").on("click.token","#users .user .token",function(){e.room.socket.emit("token use",$(this).data("user"),$(this).data("token"))})):$("body").on("click.token","#user-"+this.room.user.id+" .token",function(){e.room.socket.emit("token use",e.room.user.id,$(this).data("token"))}),this.order()},Users.prototype.destroy=function(){this.room.socket.removeAllListeners("user login"),this.room.socket.removeAllListeners("user logout"),this.room.socket.removeAllListeners("typing start"),this.room.socket.removeAllListeners("typing stop"),this.$users.off(".sortable"),$("body").off(".token").off(".sortable")};
//# sourceMappingURL=all.min.js.map
